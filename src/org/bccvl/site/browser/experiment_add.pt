<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">


  <metal:styleslot fill-slot="style_slot">
    <link rel="stylesheet"
          href="/++resource++bccvl/lib/bootstrap/css/bootstrap.css"/>
    <style>
      .modal.large {
      width: 80%; /* responsive width */
      margin-left: -40%; /* width/2 */
      }

       #datasets-popup-result .ui-selecting { background: #FECA40; }
       #datasets-popup-result .ui-selected { background: #F39814; color: white; }
    </style>
  </metal:styleslot>
  <metal:javascriptslot fill-slot="javascript_head_slot">
    <script type="text/javascript" src="/++resource++bccvl/lib/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript">
bccvl = {};

( function($) {

    function single_selectable($elements) {
        $elements.selectable({
            selected: function(event, ui) {
                $(ui.selected).addClass("ui-selected")
                    .siblings()
                    .removeClass("ui-selected");
            }
        });
    }


    bccvl.select_dataset = function($element, options) {

        var settings = $.extend({
            // These are the defaults.
            target: null,
            genre: ["DataGenreSpeciesOccurrence"],
            single: true,
            field: null,
            enable_layers: false,
            remote: 'datasets_listing_popup',
            result_selector: '#datasets-popup-result',
            result_child_selector: '#datasets-popup-result-list'
        }, options );

        // variable names that make more sense
        var $modal = settings.target;

        // hookup popup button/link to show modal
        $element.click(function(event) {
            event.preventDefault();
            // show modal
            var paramlist = [];
            $.each(settings.genre, function(index, value) {
                paramlist.push({name: 'datasets.filter.genre:list',
                                value: value});
            });
            if (settings.enable_layers) {
                paramlist.push({name: 'datasets.filter.enable_layers',
                                value: 1});
            }
            // bootstrap 2 modal does'n have loaded event so we have to do it ourselves
            $modal.modal('show')
                .find('.modal-body')
                .load(settings.remote + '?' + $.param(paramlist), function() {
                   bind_events_on_modal_content();
                });
        });

        // initialise modal when finished loading
        function bind_events_on_modal_content() {

        //}
        //$modal.on('shown', function(event) {
            // hookup events within modal
            $modal.find('form').submit(function(event) {
                event.preventDefault();
                console.log(event);
                $modal.find(settings.result_selector).load(
                    $(this).attr('action') + ' ' + settings.result_child_selector,
                    $(this).serialize(),
                    // reapply single select events
                    function() {
                        if (settings.single) {
                            single_selectable($modal.find(settings.result_child_selector));
                        } else {
                            $modal.find(settings.result_child_selector).selectable();
                        }
                    }
                );
            });
            // single select on first load
            if (settings.single) {
                single_selectable($modal.find(settings.result_child_selector));
            } else {
                $modal.find(settings.result_child_selector).selectable();
            }

        //});
        };

        // clear modal on close
        $modal.on('hidden', function() {
            $(this).removeData('modal');
            $(this).find('.modal-body').empty();
        });

        // when user preses 'save' button in modal
        $modal.find('button.btn-primary').click(function() {
            // get selected element
            var $selected = $modal.find('.ui-selected');
            var uuid;
            if (settings.enable_layers) {
                uuid = $selected.map(function() {
                    return {uuid: $(this).attr('data-uuid'),
                            layer: $(this).attr('data-layer')};
                }).get();
            } else {
                uuid = $selected.map(function() { return $(this).attr('data-uuid'); }).get();
            }
            // we have all the data we need so get rid of the modal
            $modal.modal('hide');
            if ($selected.length) {
                // fetch html for widget
                var params = [{name: 'name', value: settings.field}];
                if (settings.enable_layers) {
                    // collect all existing datasets and layers as well
                    var $cursel = $('input[name^="' + settings.field + '.dataset"]');
                    var count = 0;
                    $.each($cursel, function(index, dsinput) {
                        var $layer = $('input[name="' + $(dsinput).attr('name').replace(/\.dataset\./,'.layer.') + '"]');
                        params.push({name: 'uuid.' + count,
                                     value: $(dsinput).val()});
                        params.push({name: 'layer.' + count,
                                     value: $layer.val()});
                        count += 1;
                    });
                    $.each(uuid, function(index, value){
                        params.push({name: 'uuid.' + count, value: value.uuid});
                        params.push({name: 'layer.' + count, value: value.layer});
                        count += 1;
                    });
                    params.push({name: 'count', value: count});
                    $('#' + settings.field.replace(/\./g, '-') + '-selected').load(
                        'dataset_selectedlayers',
                        params
                    );
                } else {
                    $.each(uuid, function(index, value){
                        params.push({name: 'uuid:list', value: value});
                    });
                    $('#' + settings.field.replace(/\./g, '-') + '-selected').load(
                        'dataset_selecteditems',
                        params
                    );
                }
            }
        });

    };

}(jQuery));

$(document).ready( function() {

    // species occurrence selector
    bccvl.select_dataset($("a#datasets-occurrences-popup"), {
        target: $('#modal-occurrences'),
        genre: ['DataGenreSpeciesOccurrence'],
        field: 'form.widgets.species_occurrence_dataset'
    });
    bccvl.select_dataset($("a#datasets-absences-popup"), {
        target: $('#modal-absences'),
        genre: ['DataGenreSpeciesAbsence'],
        field: 'form.widgets.species_absence_dataset'
    });
    bccvl.select_dataset($("a#datasets-environmental-popup"), {
        target: $('#modal-environmental'),
        genre: ['DataGenreCC', 'DataGenreE'],
        single: false,
        enable_layers: true,
        field: 'form.widgets.environmental_datasets'
    });

    $('#form').on('click', 'div.field i.icon-remove', function(event){
        event.preventDefault();
        $(this).parents('div.selecteditem').remove();
    });


});

    </script>
  </metal:javascriptslot>

  <metal:main fill-slot="main">

    <!-- Modal Dialog occurrences -->
    <div id="modal-occurrences" class="modal large hide fade" tabindex="-1" role="dialog">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Select a species occurrence dataset</h3>
      </div>
      <div id="modal-body" class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button class="btn btn-primary">Save changes</button>
      </div>
    </div>
    <!-- Modal Dialog absences -->
    <div id="modal-absences" class="modal large hide fade" tabindex="-1" role="dialog">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Select a species absence dataset</h3>
      </div>
      <div id="modal-body" class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button class="btn btn-primary">Save changes</button>
      </div>
    </div>
    <!-- Modal Dialog layers -->
    <div id="modal-environmental" class="modal large hide fade" tabindex="-1" role="dialog">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Select a climate and environmental data</h3>
      </div>
      <div id="modal-body" class="modal-body"></div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button class="btn btn-primary">Add layers</button>
      </div>
    </div>

    <!-- Page content -->
    <h1 class="documentFirstHeading" tal:content="view/label">Title</h1>
    <div id="main-container" class="main-container"
         tal:define="site_url context/@@plone_portal_state/portal_url;">
      <metal:block
          use-macro="context/@@ploneform-macros/titlelessform">

        <metal:block fill-slot="fields">

          <fieldset id="fieldset-default" tal:omit-tag="not:show_default_label">
            <legend tal:condition="show_default_label"
                    tal:attributes="id string:fieldsetlegend-default"
                    tal:content="default_fieldset_label">Form name</legend>

            <!-- remove fields:
                 resolution
                 species_occurrence_dataset
                 species_absence_dataset
                 environmental_datasets
                 -->
            <tal:widget
                tal:define="widget python:view.widgets['IDublinCore.title']"
                tal:replace="structure widget/@@ploneform-render-widget"/>
            <tal:widget
                tal:define="widget python:view.widgets['IDublinCore.description']"
                tal:replace="structure widget/@@ploneform-render-widget"/>
            <tal:widget
                tal:define="widget python:view.widgets['functions']"
                tal:replace="structure widget/@@ploneform-render-widget"/>
            <!-- species occurrences -->
            <div id="formfield-form-widgets-species_occurrence_dataset" data-fieldname="form.widgets.species_occurrence_dataset" class="field z3cformInlineValidation empty">
              <label class="horizontal" for="form-widgets-species_occurrence_dataset">Species Occurrence Dataset<span title="Required" class="required horizontal">&nbsp;</span></label>
              <a id="datasets-occurrences-popup"  href="#">Select Occurrence Dataset</a>
              <div class="fieldErrorBox"></div>
              <div id="form-widgets-species_occurrence_dataset-selected">
              </div>
            </div>
            <!-- species absences -->
            <div id="formfield-form-widgets-species_absence_dataset" data-fieldname="form.widgets.species_absence_dataset" class="field z3cformInlineValidation empty">
              <label class="horizontal" for="form-widgets-species_absence_dataset">Species Absence Dataset<span title="Required" class="required horizontal">&nbsp;</span></label>
              <a id="datasets-absences-popup"  href="#">Select Absence Dataset</a>
              <div class="fieldErrorBox"></div>
              <div id="form-widgets-species_absence_dataset-selected">
              </div>
            </div>
            <tal:widget
                tal:define="widget python:view.widgets['species_pseudo_absence_points']"
                tal:replace="structure widget/@@ploneform-render-widget"/>
            <tal:widget
                tal:define="widget python:view.widgets['species_number_pseudo_absence_points']"
                tal:replace="structure widget/@@ploneform-render-widget"/>
            <tal:widget
                tal:define="widget python:view.widgets['resolution']"
                tal:replace="structure widget/@@ploneform-render-widget"/>
            <!-- climate and environmental layers -->
            <div id="formfield-form-widgets-environmental_datasets" data-fieldname="form.widgets.environmental_datasets" class="field z3cformInlineValidation empty">
              <label class="horizontal" for="form-widgets-environmental_datasets">Environmental Datasets<span title="Required" class="required horizontal">&nbsp;</span></label>
              <a id="datasets-environmental-popup"  href="#">Select Climate and Environmental Data</a>
              <div class="fieldErrorBox"></div>
              <div id="form-widgets-environmental_datasets-selected">
              </div>
            </div>

          </fieldset>
          <!-- secondary fieldsets -->
          <tal:block tal:repeat="group groups" condition="has_groups">
            <fieldset
                tal:define="normalizeString nocall:context/@@plone/normalizeString;
                            fieldset_label group/label;
                            fieldset_name python:getattr(group, '__name__', False) or getattr(group.label, 'default', False) or fieldset_label;
                            fieldset_name python:normalizeString(fieldset_name);"
                tal:attributes="id string:fieldset-${fieldset_name};
                                class string:kssattr-fieldset-${fieldset_name};
                                data-fieldset fieldset_name">
              <legend tal:condition="fieldset_label"
                      tal:attributes="id string:fieldsetlegend-${fieldset_name}"
                      tal:content="fieldset_label">Form name</legend>
              <p i18n:translate=""
                 tal:define="group_description group/description|nothing"
                 tal:condition="group_description"
                 tal:content="structure group_description">
                Description
              </p>
              <tal:block tal:define="errors group/widgets/errors"
                         tal:condition="errors"
                         tal:repeat="error errors">
                <div class="field error"
                     tal:condition="not:nocall:error/widget"
                     tal:content="structure error/render"
                     />
              </tal:block>
              <tal:block define="view nocall:group">
                <metal:block use-macro="context/@@ploneform-macros/widget_rendering" />
              </tal:block>
            </fieldset>
          </tal:block>
          <!-- Algorithm parameter fieldsets -->
          <metal:parameters use-macro="context/@@experiment-macros/algo_parameters"/>
        </metal:block>
      </metal:block>
      <script id="bccvl-lookups" tal:content="view/occurrences_mapping" />
    </div>
  </metal:main>
</html>
